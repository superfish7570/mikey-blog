FROM registry.cn-beijing.aliyuncs.com/authing-public/node-ossutil:14
WORKDIR /app
ARG NPM_TOKEN
ARG PUBLISH_OPTS
ARG ALIYUN_ACCESS_KEY
ARG ALIYUN_ACCESS_KEY_SECRET
ARG OSS_REGION_PROD
ARG CDN_OSS_PROD
ARG VERSION
COPY . .
RUN yarn \
    && npm i -g cnpm \
    && npm config set //registry.npmjs.org/:_authToken ${NPM_TOKEN} \
    && yarn build \
    && npm publish ${PUBLISH_OPTS} \
    && cnpm sync authing-js-sdk \
    && ossutil --access-key-id ${ALIYUN_ACCESS_KEY}  --access-key-secret ${ALIYUN_ACCESS_KEY_SECRET} -e ${OSS_REGION_PROD} cp -r -f build oss://${CDN_OSS_PROD}/packages/authing-js-sdk/${VERSION}/
